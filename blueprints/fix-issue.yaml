name: fix-issue
steps:
  - id: clone
    type: deterministic
    action: git_clone
    params:
      repo: "{{task.repo_url}}"
      branch: "fix/{{task.issue_id}}"

  - id: load_context
    type: deterministic
    action: load_context
    params:
      issue_id: "{{task.issue_id}}"

  - id: implement
    type: agent
    tools: [read, write, edit, bash, search_code, list_files]
    prompt: |
      Fix the following issue:
      {{context.issue_description}}

      Follow project rules:
      {{context.rules}}
    max_iterations: 20

  - id: lint
    type: deterministic
    action: run_lint

  - id: fix_lint
    type: agent
    condition: "{{steps.lint.exit_code == 1}}"
    tools: [read, edit]
    prompt: "Fix these lint errors:\n{{steps.lint.error}}"
    max_iterations: 5

  - id: push
    type: deterministic
    action: git_push

  - id: create_mr
    type: deterministic
    action: create_merge_request
    params:
      title: "Fix #{{task.issue_id}}: {{task.title}}"
      description: "{{steps.implement.summary}}"
